name: Daily Cleanup

on:
  schedule:
    # Run daily at 3 AM UTC
    - cron: '0 3 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  cleanup:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Trigger Cleanup API
        env:
          APP_URL: ${{ secrets.APP_URL || 'https://your-app.vercel.app' }}
          CLEANUP_SECRET: ${{ secrets.CLEANUP_SECRET }}
        run: |
          echo "ðŸ§¹ Running daily cleanup..."
          
          response=$(curl -s -w "\n%{http_code}" \
            -X POST \
            -H "Content-Type: application/json" \
            -H "x-cleanup-secret: $CLEANUP_SECRET" \
            "$APP_URL/api/cleanup")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          
          echo "Response: $body"
          echo "HTTP Status: $http_code"
          
          if [ "$http_code" -eq "200" ]; then
            echo "âœ… Cleanup completed successfully!"
            echo "$body" | jq '.' 2>/dev/null || echo "$body"
          else
            echo "âŒ Cleanup failed with status $http_code"
            exit 1
          fi

      - name: Summary
        run: |
          echo "### ðŸ§¹ Daily Cleanup Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Time**: $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: Success âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Retention Policies Applied:**" >> $GITHUB_STEP_SUMMARY
          echo "- Inactive workflows: 15 days" >> $GITHUB_STEP_SUMMARY
          echo "- Execution logs: 7 days" >> $GITHUB_STEP_SUMMARY
          echo "- Usage tracking: 90 days" >> $GITHUB_STEP_SUMMARY
